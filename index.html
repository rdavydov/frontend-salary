<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Зарплаты Frontend-разработчиков</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chart.js Boxplot Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-boxplot@4.2.4/build/index.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #2b5df0;
            --primary-hover: #1a45c7;
            --text-color: #333;
            --bg-color: #f8f9fa;
            --card-bg: #ffffff;
            --border-color: #e0e0e0;
            --success-color: #28a745;
            --error-color: #dc3545;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 0;
            margin: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px 0;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .salary-display {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .salary-amount {
            font-size: 3.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
        }

        .salary-label {
            font-size: 1.2rem;
            color: #666;
        }

        .controls {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn:hover, .btn:focus {
            background-color: var(--primary-hover);
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        .btn:disabled {
             background-color: #cccccc;
             cursor: not-allowed;
        }

        .instructions {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9f4ff;
            border-radius: 5px;
            display: none; /* Hidden by default */
        }

        .instructions h3 {
            margin-top: 0;
        }

        .instructions ol {
            text-align: left;
            padding-left: 20px;
        }

        .instructions li {
            margin-bottom: 10px;
        }

        textarea {
            width: 100%;
            height: 150px;
            margin-top: 15px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9rem;
            resize: vertical;
            display: none; /* Hidden by default */
        }

        .process-btn {
            margin-top: 15px;
            display: none; /* Hidden by default */
        }

        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            display: none;
        }

        .message.error {
            background-color: #f8d7da;
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }

        .message.success {
            background-color: #d4edda;
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }


        .chart-container {
            background-color: var(--card-bg);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid var(--border-color);
            display: none; /* Hidden by default */
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .salary-amount {
                font-size: 2.5rem;
            }

            .salary-display, .controls, .chart-container {
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.3rem;
            }

            .salary-amount {
                font-size: 2rem;
            }

            .btn {
                width: 100%;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Зарплаты Frontend-разработчиков в России</h1>
        </header>

        <main>
            <section class="salary-display">
                <p class="salary-label">Медианная зарплата (All)</p>
                <div id="medianSalary" class="salary-amount">-- ₽</div>
                <p>Данные загружаются...</p>
            </section>

            <section class="controls">
                <button id="fetchDataBtn" class="btn">1. Получить актуальные данные</button>
                <div id="instructions" class="instructions">
                    <h3>Инструкция:</h3>
                    <ol>
                        <li>Откроется новая вкладка с данными API.</li>
                        <li>Скопируйте всё содержимое страницы (Ctrl+A, затем Ctrl+C).</li>
                        <li>Вернитесь на эту вкладку.</li>
                        <li>Вставьте скопированные данные в поле ниже.</li>
                        <li>Нажмите кнопку "2. Обработать данные".</li>
                    </ol>
                </div>
                <textarea id="jsonDataInput" placeholder='Вставьте скопированный JSON сюда...'></textarea>
                <button id="processDataBtn" class="btn process-btn">2. Обработать данные</button>
                <div id="message" class="message"></div>
            </section>

            <section class="chart-container">
                <h2 style="margin-bottom: 20px;">Распределение зарплат по уровням</h2>
                <canvas id="salaryChart"></canvas>
            </section>
        </main>

        <footer>
            <p>Данные предоставлены <a href="https://career.habr.com/salaries/frontend-developer" target="_blank" rel="noopener noreferrer">Habr Career</a>.</p>
        </footer>
    </div>

    <script>
        const API_URL = 'https://career.habr.com/api/frontend_v1/salary_calculator/general_graph?spec_aliases%5B%5D=frontend';
        const fetchDataBtn = document.getElementById('fetchDataBtn');
        const instructions = document.getElementById('instructions');
        const jsonDataInput = document.getElementById('jsonDataInput');
        const processDataBtn = document.getElementById('processDataBtn');
        const medianSalaryDisplay = document.getElementById('medianSalary');
        const chartContainer = document.querySelector('.chart-container');
        const messageDiv = document.getElementById('message');

        let chartInstance = null; // To hold the Chart.js instance

        // 1. Open API URL in new tab
        fetchDataBtn.addEventListener('click', () => {
            window.open(API_URL, '_blank');
            instructions.style.display = 'block';
            jsonDataInput.style.display = 'block';
            medianSalaryDisplay.textContent = '-- ₽';
            medianSalaryDisplay.nextElementSibling.textContent = 'Ожидание данных...';
            if (chartContainer.style.display === 'block') {
                 chartContainer.style.display = 'none';
                 if (chartInstance) {
                     chartInstance.destroy();
                     chartInstance = null;
                 }
            }
            hideMessage();
        });

        // 2. Enable process button when data is pasted
        jsonDataInput.addEventListener('input', () => {
            if (jsonDataInput.value.trim() !== '') {
                processDataBtn.style.display = 'inline-block';
            } else {
                processDataBtn.style.display = 'none';
                hideMessage();
            }
        });

        // 3. Process the pasted data
        processDataBtn.addEventListener('click', () => {
            const jsonDataStr = jsonDataInput.value.trim();
            if (!jsonDataStr) {
                showMessage('Пожалуйста, вставьте данные.', 'error');
                return;
            }

            let data;
            try {
                data = JSON.parse(jsonDataStr);
            } catch (e) {
                showMessage('Ошибка: Вставленные данные не являются корректным JSON.', 'error');
                console.error("JSON Parse Error:", e);
                return;
            }

            if (!data.groups || !Array.isArray(data.groups)) {
                 showMessage('Ошибка: Неверный формат данных. Ожидается объект с полем "groups".', 'error');
                 console.error("Invalid data format:", data);
                 return;
            }

            showMessage('Данные успешно загружены!', 'success');

            // Find "All" group data
            const allGroup = data.groups.find(group => group.name === "All");
            if (allGroup && allGroup.median) {
                medianSalaryDisplay.textContent = `${formatNumber(allGroup.median)} ₽`;
                medianSalaryDisplay.nextElementSibling.textContent = 'Актуальная медианная зарплата';
            } else {
                medianSalaryDisplay.textContent = 'N/A';
                medianSalaryDisplay.nextElementSibling.textContent = 'Медианная зарплата недоступна';
            }

            // Prepare data for Chart.js Boxplot
            const chartData = prepareChartData(data.groups);

            // Render Chart
            renderChart(chartData);

            // Show chart container
            chartContainer.style.display = 'block';

            // Scroll to chart
            chartContainer.scrollIntoView({ behavior: 'smooth' });
        });

        function prepareChartData(groups) {
             // Filter out "All" and potentially groups with missing data
             const filteredGroups = groups
                 .filter(g => g.name !== "All" && g.min != null && g.p25 != null && g.median != null && g.p75 != null && g.max != null)
                 .sort((a, b) => { // Sort by median salary
                     return (a.median || 0) - (b.median || 0);
                 });

             const labels = filteredGroups.map(g => g.title || g.name);
             const datasets = filteredGroups.map(g => [g.min, g.p25, g.median, g.p75, g.max]);

             return { labels, datasets };
        }

        function renderChart(chartData) {
            const ctx = document.getElementById('salaryChart').getContext('2d');

            // Destroy previous chart instance if exists
            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'boxplot',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: 'Зарплата (₽)',
                        data: chartData.datasets,
                        backgroundColor: 'rgba(43, 93, 240, 0.2)',
                        borderColor: 'rgba(43, 93, 240, 1)',
                        borderWidth: 1,
                        outlierRadius: 3, // Make outliers less prominent
                        itemRadius: 0, // Hide individual item points
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatNumber(value) + ' ₽'; // Format Y axis labels
                                }
                            }
                        }
                    },
                    plugins: {
                         legend: {
                             display: false // Hide legend as it's not needed for one dataset
                         },
                         tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     // Customize tooltip to show min, q1, median, q3, max
                                     const raw = context.raw;
                                     if (raw && Array.isArray(raw)) {
                                         return [
                                             `Мин: ${formatNumber(raw[0])} ₽`,
                                             `25%: ${formatNumber(raw[1])} ₽`,
                                             `Медиана: ${formatNumber(raw[2])} ₽`,
                                             `75%: ${formatNumber(raw[3])} ₽`,
                                             `Макс: ${formatNumber(raw[4])} ₽`
                                         ];
                                     }
                                     return context.dataset.label + ': ' + context.parsed.y;
                                 }
                             }
                         }
                    }
                }
            });
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('ru-RU').format(num);
        }

        function showMessage(text, type) {
            messageDiv.textContent = text;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';
        }

        function hideMessage() {
            messageDiv.style.display = 'none';
        }

        // Initial load attempt (might fail due to CORS, but good practice)
        window.addEventListener('DOMContentLoaded', () => {
             fetch(API_URL)
                 .then(response => {
                     if (!response.ok) {
                         throw new Error(`HTTP error! status: ${response.status}`);
                     }
                     return response.json();
                 })
                 .then(data => {
                     if (data && data.groups) {
                         const allGroup = data.groups.find(g => g.name === "All");
                         if (allGroup && allGroup.median) {
                             medianSalaryDisplay.textContent = `${formatNumber(allGroup.median)} ₽`;
                             medianSalaryDisplay.nextElementSibling.textContent = 'Актуальная медианная зарплата';
                         }
                     }
                 })
                 .catch(error => {
                     console.log("Автоматическая загрузка данных не удалась (возможно, CORS):", error);
                     // The manual process is the fallback, so no need for a specific error message here
                     medianSalaryDisplay.nextElementSibling.textContent = 'Нажмите кнопку, чтобы получить данные.';
                 });
        });
    </script>
</body>
</html>
